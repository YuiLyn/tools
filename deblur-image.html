let img = null;
let canvas = null;
let originalImgSrc = '';
let deblurredImgSrc = '';

function enableDeblurButton() {
    const deblurButton = document.getElementById('deblurButton');
    deblurButton.disabled = false;
    deblurButton.textContent = '修復圖片';
    deblurButton.style.backgroundColor = '#4CAF50';
    deblurButton.style.color = 'white';
    deblurButton.style.cursor = 'pointer';
    console.log("修復按鈕已啟用");
}

function disableDeblurButton() {
    const deblurButton = document.getElementById('deblurButton');
    deblurButton.disabled = true;
    deblurButton.textContent = '正在加載 OpenCV';
    deblurButton.style.backgroundColor = '#ccc';
    deblurButton.style.color = '#666';
    deblurButton.style.cursor = 'not-allowed';
    console.log("修復按鈕已禁用");
}

function loadImage() {
    const file = document.getElementById('imageUpload').files[0];
    if (!file) {
        alert("請選擇一個圖片檔案！");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        img = new Image();
        img.crossOrigin = "Anonymous";
        img.src = e.target.result;
        img.onload = function() {
            if (img.width === 0 || img.height === 0) {
                alert("圖片尺寸無效，請檢查檔案！");
                return;
            }
            if (img.width > 2000 || img.height > 2000) {
                alert("圖片尺寸過大，請選擇較小的圖片（建議 2000x2000 像素以下）！");
                return;
            }
            document.getElementById('result').innerHTML = "圖片已加載，請點擊「修復圖片」按鈕修復...";
            originalImgSrc = img.src;
            deblurredImgSrc = '';
            if (cv) {
                enableDeblurButton(); // 如果 OpenCV 已加載，啟用按鈕
            }
        };
        img.onerror = function() {
            alert("圖片加載失敗，請檢查檔案格式或網絡！");
            hideProgress(); // 隱藏進度條
        };
    };
    reader.onerror = function() {
        alert("檔案讀取失敗，請檢查檔案或網絡！");
        hideProgress(); // 隱藏進度條
    };
    reader.readAsDataURL(file);
}

function showProgress() {
    const progressContainer = document.getElementById('progressContainer');
    progressContainer.style.display = 'block';
    updateProgress(0);
}

function hideProgress() {
    const progressContainer = document.getElementById('progressContainer');
    progressContainer.style.display = 'none';
    updateProgress(0);
}

function updateProgress(percentage) {
    const progress = document.getElementById('progress');
    const progressText = document.getElementById('progressText');
    progress.style.width = `${percentage}%`;
    progressText.textContent = `處理中：${percentage}%`;
}

function deblurImage() {
    if (!img || !cv) {
        alert("請等待 OpenCV.js 加載完成或檢查網絡連線！");
        hideProgress();
        return;
    }

    const resultDiv = document.getElementById('result');
    canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    if (!ctx) {
        alert("瀏覽器不支持 canvas，請使用現代瀏覽器（如 Chrome 或 Safari）！");
        hideProgress();
        return;
    }
    canvas.width = img.width;
    canvas.height = img.height;

    try {
        ctx.drawImage(img, 0, 0);
        console.log("圖片繪製到 canvas 成功，尺寸：", canvas.width, "x", canvas.height);

        // 將圖片數據轉換為 OpenCV Mat
        const src = cv.imread(canvas);
        const dst = new cv.Mat();
        const kernel = cv.Mat.ones(3, 3, cv.CV_32F); // 3x3 模糊核（可調整）
        kernel.convertTo(kernel, cv.CV_32F, 1/9, 0); // 均值模糊核

        // 模擬進度（基於圖片行數）
        let progress = 0;
        const totalRows = src.rows;
        let processedRows = 0;

        // Wiener Deconvolution（使用 OpenCV）
        cv.wienerDeconvolution(src, dst, kernel, 0.01); // 噪聲水平設置為 0.01（可調整）
        // 或者 Lucy-Richardson Deconvolution
        // cv.deconvolution(src, dst, kernel, 15); // 迭代次數設為 15（可調整）

        // 更新進度（模擬處理）
        for (let i = 0; i < src.rows; i++) {
            processedRows++;
            progress = Math.floor((processedRows / totalRows) * 100);
            updateProgress(progress);
        }

        // 將結果繪製回 canvas
        cv.imshow(canvas, dst);
        deblurredImgSrc = canvas.toDataURL();

        // 清理 OpenCV 記憶體
        src.delete();
        dst.delete();
        kernel.delete();

        // 顯示左右分屏對比
        resultDiv.innerHTML = `
            <div class="comparison-container">
                <div class="comparison-image">
                    <img src="${originalImgSrc}" alt="Before">
                    <div class="label">Before</div>
                </div>
                <div class="comparison-image">
                    <img src="${deblurredImgSrc}" alt="After">
                    <div class="label">After</div>
                </div>
            </div>
            <p>直接查看修復前後對比，選擇輸出格式並下載修復後的圖片。</p>
        `;
        document.getElementById('downloadOptions').style.display = 'block';
        document.getElementById('downloadButton').style.display = 'block';

        // 添加點擊放大事件
        const beforeImg = resultDiv.querySelector('.comparison-image:first-child img');
        const afterImg = resultDiv.querySelector('.comparison-image:last-child img');
        if (beforeImg && afterImg) {
            beforeImg.addEventListener('click', showModal);
            afterImg.addEventListener('click', showModal);
        }
        hideProgress(); // 隱藏進度條
    } catch (error) {
        alert("圖片修復失敗，請檢查瀏覽器或檔案！錯誤：", error.message);
        hideProgress(); // 隱藏進度條
    }
}

// 綁定按鈕點擊事件
document.getElementById('deblurButton').addEventListener('click', function() {
    showProgress(); // 顯示進度條
    deblurImage(); // 執行圖片修復
});

function downloadDeblurredImage() {
    if (!canvas) {
        alert("請先修復圖片！");
        return;
    }

    const format = document.getElementById('imageFormat').value;
    let dataURL;
    if (format === 'png') {
        dataURL = canvas.toDataURL('image/png');
    } else if (format === 'jpg') {
        dataURL = canvas.toDataURL('image/jpeg', 0.95);
    }

    const link = document.createElement('a');
    link.href = dataURL;
    link.download = `deblurred_image.${format}`;
    link.click();
}

function showModal(e) {
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    const imgSrc = e.target.src;
    modalContent.innerHTML = `<img src="${imgSrc}" alt="Zoomed Image">`;
    modal.style.display = 'flex';
}

function closeModal() {
    const modal = document.getElementById('modal');
    modal.style.display = 'none';
}
</script>
