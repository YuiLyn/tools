<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修復模糊圖片工具</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .comparison-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
        }
        .comparison-image {
            width: 48%;
            border: 2px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        .comparison-image img {
            width: 100%;
            height: auto;
            display: block;
        }
        .label {
            text-align: center;
            font-weight: bold;
            margin-top: 5px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>修復模糊圖片工具</h1>
        <div class="input-group">
            <label for="imageUpload">上傳模糊圖片:</label>
            <input type="file" id="imageUpload" accept="image/*" onchange="loadImage()">
        </div>
        <div class="input-group">
            <label for="sharpenLevel">銳化強度 (0-100):</label>
            <input type="range" id="sharpenLevel" min="0" max="100" value="50">
            <span id="sharpenValue">50</span>
        </div>
        <button onclick="deblurImage()" disabled id="deblurButton">修復圖片</button>
        <div class="input-group" style="display: none;" id="downloadOptions">
            <label for="imageFormat">選擇輸出格式:</label>
            <select id="imageFormat">
                <option value="png">PNG</option>
                <option value="jpg">JPG</option>
            </select>
        </div>
        <button onclick="downloadDeblurredImage()" style="display: none;" id="downloadButton">下載修復後的圖片</button>
        <div class="result" id="result"></div>
        <p><a href="index.html">返回工具主頁</a></p>
    </div>
    <script>
        let img = null;
        let canvas = null;

        function loadImage() {
            const file = document.getElementById('imageUpload').files[0];
            if (!file) {
                alert("請選擇一個圖片檔案！");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    document.getElementById('result').innerHTML = "圖片已加載，準備修復！";
                    document.getElementById('deblurButton').disabled = false;
                    showPreview(); // 顯示初始預覽（修復前）
                };
            };
            reader.readAsDataURL(file);
        }

        function showPreview() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div class="comparison-container">
                    <div class="comparison-image">
                        <img src="${img.src}" alt="Before">
                        <div class="label">Before</div>
                    </div>
                    <div class="comparison-image" id="afterPreview">
                        <img src="${img.src}" alt="After" style="filter: blur(5px);">
                        <div class="label">After</div>
                    </div>
                </div>
            `;
        }

        function deblurImage() {
            if (!img) {
                alert("請先上傳圖片！");
                return;
            }

            const sharpenLevel = parseInt(document.getElementById('sharpenLevel').value) / 100;
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = "正在修復圖片，請稍候...";

            // 創建 canvas 來處理圖片
            canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;

            // 繪製原始圖片到 canvas
            ctx.drawImage(img, 0, 0);

            // 優化的銳化濾波器（調整卷積矩陣和亮度處理）
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const sharpenMatrix = [
                [-1, -1, -1],
                [-1, 9, -1],  // 將中心值從 5 調整為 9，增強邊緣並減少灰暗
                [-1, -1, -1]
            ];

            // 備份原始亮度以保持顏色平衡
            const originalBrightness = [];
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                originalBrightness.push((r + g + b) / 3); // 計算平均亮度
            }

            for (let y = 1; y < canvas.height - 1; y++) {
                for (let x = 1; x < canvas.width - 1; x++) {
                    for (let c = 0; c < 3; c++) { // RGB 通道
                        let sum = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const pixelIndex = ((y + ky) * canvas.width + (x + kx)) * 4 + c;
                                sum += data[pixelIndex] * sharpenMatrix[ky + 1][kx + 1];
                            }
                        }
                        const currentIndex = (y * canvas.width + x) * 4 + c;
                        // 調整亮度，保持原始亮度的比例
                        const originalBright = originalBrightness[(y * canvas.width + x)];
                        let newValue = sum * sharpenLevel;
                        newValue = Math.min(255, Math.max(0, newValue));
                        // 根據原始亮度調整，減少灰暗
                        newValue = newValue * (1 + (originalBright / 255) * 0.3); // 增加亮度補償
                        data[currentIndex] = Math.min(255, Math.max(0, newValue));
                    }
                }
            }

            ctx.putImageData(imageData, 0, 0);

            // 更新預覽（修復後）
            const afterPreview = document.getElementById('afterPreview');
            const deblurredImg = new Image();
            deblurredImg.src = canvas.toDataURL();
            deblurredImg.onload = function() {
                afterPreview.innerHTML = '';
                const imgElement = document.createElement('img');
                imgElement.src = deblurredImg.src;
                imgElement.style.width = '100%';
                imgElement.style.height = 'auto';
                afterPreview.appendChild(imgElement);
                afterPreview.querySelector('.label').textContent = 'After';
            };

            resultDiv.innerHTML = `
                <div class="comparison-container">
                    <div class="comparison-image">
                        <img src="${img.src}" alt="Before">
                        <div class="label">Before</div>
                    </div>
                    <div class="comparison-image" id="afterPreview">
                        <img src="${deblurredImg.src}" alt="After">
                        <div class="label">After</div>
                    </div>
                </div>
            `;
            resultDiv.innerHTML += "<p>修復完成！選擇輸出格式並下載修復後的圖片。</p>";
            document.getElementById('downloadOptions').style.display = 'block';
            document.getElementById('downloadButton').style.display = 'block';
        }

        function downloadDeblurredImage() {
            if (!canvas) {
                alert("請先修復圖片！");
                return;
            }

            const format = document.getElementById('imageFormat').value;
            let dataURL;
            if (format === 'png') {
                dataURL = canvas.toDataURL('image/png');
            } else if (format === 'jpg') {
                dataURL = canvas.toDataURL('image/jpeg', 0.95); // JPG 質量設為 95%
            }

            const link = document.createElement('a');
            link.href = dataURL;
            link.download = `deblurred_image.${format}`;
            link.click();
        }

        // 實時更新銳化強度顯示
        document.getElementById('sharpenLevel').addEventListener('input', function() {
            document.getElementById('sharpenValue').textContent = this.value;
            if (img) {
                deblurImage(); // 實時更新預覽
            }
        });
    </script>
</body>
</html>
