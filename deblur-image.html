<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修復模糊圖片工具</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f0f0; }
        .container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 400px; }
        .input-group { margin: 20px 0; }
        label { display: block; margin-bottom: 5px; }
        input { padding: 8px; font-size: 16px; width: 100%; max-width: 200px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 16px; border: none; border-radius: 4px; cursor: pointer; margin: 20px auto; display: block; }
        button:disabled { background-color: #ccc; color: #666; cursor: not-allowed; }
        button:enabled { background-color: #4CAF50; color: white; }
        button:enabled:hover { background-color: #45a049; }
        .result { margin-top: 20px; font-size: 18px; }
        .comparison-container { display: flex; justify-content: space-between; width: 100%; max-width: 800px; margin: 20px auto; }
        .comparison-image { width: 48%; border: 2px solid #ccc; border-radius: 8px; }
        .comparison-image img { width: 100%; height: auto; }
        .label { text-align: center; font-weight: bold; margin-top: 5px; }
        .progress-container { width: 100%; max-width: 400px; margin: 20px auto; display: none; }
        .progress-bar { width: 100%; height: 20px; background-color: #f0f0f0; border-radius: 10px; overflow: hidden; }
        .progress { height: 100%; background-color: #4CAF50; width: 0%; transition: width 0.3s; }
        .progress-text { text-align: center; margin-top: 5px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>修復模糊圖片工具</h1>
        <div class="input-group">
            <label for="imageUpload">上傳模糊圖片:</label>
            <input type="file" id="imageUpload" accept="image/*" onchange="loadImage()">
        </div>
        <button id="deblurButton" disabled>正在加載 OpenCV</button>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
            <div class="progress-text" id="progressText">處理中：0%</div>
        </div>
        <div class="result" id="result"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/opencv.js@1.2.1/opencv.min.js" async onload="onOpenCVReady()"></script>
    <script>
        let cv = null;
        let img = null;
        let originalImgSrc = '';
        let deblurredImgSrc = '';

        function onOpenCVReady() {
            cv = window.cv;
            document.getElementById('deblurButton').disabled = false;
            document.getElementById('deblurButton').textContent = '修復圖片';
        }

        function loadImage() {
            const file = document.getElementById('imageUpload').files[0];
            if (!file) {
                alert("請選擇一個圖片檔案！");
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    document.getElementById('result').innerHTML = "圖片已加載，請點擊「修復圖片」按鈕修復...";
                    originalImgSrc = img.src;
                };
            };
            reader.readAsDataURL(file);
        }

        function deblurImage() {
            if (!img || !cv) {
                alert("請先上傳圖片並確保 OpenCV 已加載！");
                return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);

            // 顯示進度條
            showProgress();

            // OpenCV 處理
            const src = cv.imread(canvas);
            const denoised = new cv.Mat();
            const dst = new cv.Mat();

            // 降噪：高斯模糊
            cv.GaussianBlur(src, denoised, new cv.Size(5, 5), 1.5);

            // 去模糊：Wiener Deconvolution 模擬（簡單濾波）
            const kernel = cv.Mat.ones(3, 3, cv.CV_32F);
            cv.convertScaleAbs(kernel, kernel, 1/9); // 降低濾波強度
            cv.filter2D(denoised, dst, -1, kernel);

            // 輸出結果
            cv.imshow(canvas, dst);
            deblurredImgSrc = canvas.toDataURL();

            // 清理記憶體
            src.delete(); denoised.delete(); dst.delete(); kernel.delete();

            // 顯示對比
            document.getElementById('result').innerHTML = `
                <div class="comparison-container">
                    <div class="comparison-image">
                        <img src="${originalImgSrc}" alt="Before">
                        <div class="label">修復前</div>
                    </div>
                    <div class="comparison-image">
                        <img src="${deblurredImgSrc}" alt="After">
                        <div class="label">修復後</div>
                    </div>
                </div>
            `;

            // 隱藏進度條
            hideProgress();
        }

        document.getElementById('deblurButton').addEventListener('click', deblurImage);

        function showProgress() {
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.style.display = 'block';
            updateProgress(50); // 模擬進度
        }

        function hideProgress() {
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.style.display = 'none';
            updateProgress(0);
        }

        function updateProgress(percentage) {
            const progress = document.getElementById('progress');
            const progressText = document.getElementById('progressText');
            progress.style.width = `${percentage}%`;
            progressText.textContent = `處理中：${percentage}%`;
        }
    </script>
</body>
</html>
