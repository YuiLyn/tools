function deblurImage() {
    if (!img) {
        alert("請先上傳圖片！");
        return;
    }

    const resultDiv = document.getElementById('result');
    canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    if (!ctx) {
        alert("瀏覽器不支持 canvas，請使用現代瀏覽器（如 Chrome 或 Safari）！");
        return;
    }
    canvas.width = img.width;
    canvas.height = img.height;

    try {
        ctx.drawImage(img, 0, 0);

        // 簡單的盲去模糊（模擬 Blind Deconvolution）
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const initialKernel = new Array(9).fill(1/9); // 初始模糊核（3x3 均值濾波器）
        let deblurredData = new Uint8ClampedArray(data.length);

        for (let y = 1; y < canvas.height - 1; y++) {
            for (let x = 1; x < canvas.width - 1; x++) {
                for (let c = 0; c < 3; c++) {
                    let sum = 0;
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const pixelIndex = ((y + ky) * canvas.width + (x + kx)) * 4 + c;
                            sum += data[pixelIndex] * initialKernel[(ky + 1) * 3 + (kx + 1)];
                        }
                    }
                    const currentIndex = (y * canvas.width + x) * 4 + c;
                    deblurredData[currentIndex] = Math.min(255, Math.max(0, sum * 1.5)); // 簡單增強
                }
            }
        }

        // 更新圖片數據
        imageData.data.set(deblurredData);
        ctx.putImageData(imageData, 0, 0);
        deblurredImgSrc = canvas.toDataURL();

        // 顯示左右分屏對比
        resultDiv.innerHTML = `
            <div class="comparison-container">
                <div class="comparison-image">
                    <img src="${originalImgSrc}" alt="Before">
                    <div class="label">Before</div>
                </div>
                <div class="comparison-image">
                    <img src="${deblurredImgSrc}" alt="After">
                    <div class="label">After</div>
                </div>
            </div>
            <p>直接查看修復前後對比，選擇輸出格式並下載修復後的圖片。</p>
        `;
        document.getElementById('downloadOptions').style.display = 'block';
        document.getElementById('downloadButton').style.display = 'block';

        // 添加點擊放大事件
        const beforeImg = resultDiv.querySelector('.comparison-image:first-child img');
        const afterImg = resultDiv.querySelector('.comparison-image:last-child img');
        if (beforeImg && afterImg) {
            beforeImg.addEventListener('click', showModal);
            afterImg.addEventListener('click', showModal);
        }
    } catch (error) {
        alert("圖片修復失敗，請檢查瀏覽器或檔案！錯誤：", error.message);
    }
}
